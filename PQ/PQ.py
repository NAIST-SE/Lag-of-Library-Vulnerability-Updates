import json
import glob
from collections import defaultdict as ddict
from scipy import stats
import plotly.graph_objs as go

def PQ1(vul_list):
    counter = ddict(int)
    fixing_release_update = ['major', 'minor', 'patch']

    for vul in vul_list:
        counter[vul['release_type']] += 1

    print('='*50)
    print('(PQ1) fixing release update distribution')
    for it in fixing_release_update:
        print('%s: %d'%(it, counter[it]))
    print('='*50)
    print()

def PQ2(vul_list):
    plot_cumulative_frequency(vul_list)
    plot_fixing_commit_dist(vul_list)

    print('='*50)
    print('(PQ2) ploting cumulative frequency distribution of fixing commits: cum_freq_dist.pdf')
    print('(PQ2) ploting lines of code distribution in fixing commits: loc_fixing_commit.pdf')
    print('='*50)
    print()

def plot_cumulative_frequency(vul_list):
    percent_fixing_commits = sorted([vul['num_fix_commit']/vul['num_release_commit']*100 for vul in vul_list])
    cumulative_frequency = stats.cumfreq(percent_fixing_commits, defaultreallimits = (-1, 101), numbins=len(percent_fixing_commits))

    trace = go.Scatter(
        name = 'Fixing release',
        x = [0] + percent_fixing_commits,
        y = [0] + list(map(lambda w: w/len(percent_fixing_commits) * 100, cumulative_frequency.cumcount))
    )

    layout = go.Layout(
        showlegend = False,
        yaxis = dict(
            title = 'Cumulative Frequency Distribution',
            titlefont = dict(size=16),
            range = [0, 100],
            ticksuffix = '%'
        ),
        xaxis = dict(
            title = '% fix commits in a release',
            titlefont = dict(size=16),
            range = [0, 20],
            ticksuffix = '%'
        ),
        shapes = [
            dict(
                type = 'line',
                x0 = 7.14257,
                x1 = 7.14257,
                y0 = 0,
                y1 = 110,
                line = dict(
                    color = 'black',
                    dash = 'dash'
                )
            ),
            dict(
                type = 'line',
                x0 = 0,
                x1 = 110,
                y0 = 93.89313,
                y1 = 93.89313,
                line = dict(
                    color = 'black',
                    dash = 'dash'
                )
            )
        ]
    )

    fig = go.Figure(data=[trace], layout=layout)
    fig.write_image('cum_freq_dist.pdf', height=400, width=600)
    
def plot_fixing_commit_dist(vul_list):
    lines_of_codes = [vul['num_fix_lines'] for vul in vul_list]

    trace = go.Box(
        y = lines_of_codes,
        name = 'Fixing commit',
        boxpoints=False,
    )

    layout = go.Layout(
        yaxis = dict(
            title = '# Lines of Code',
            titlefont = dict(size=16),
            range = [0, 25],
            dtick=2
        ),
        xaxis = dict(
            titlefont = dict(size=16)
        ),
        showlegend=False
    )

    fig = go.Figure(data=[trace], layout=layout)
    fig.write_image('loc_fixing_commit.pdf', height=400, width=600)

def add_change_line(vul_list):
    with open('rq1_data.json') as f: obj_list = json.loads(f.read())
    
    change = dict()
    for obj in obj_list:
        change[obj['snyk_id']] = obj['num_change_lines'][0]

    for vul in vul_list:
        vul['num_fix_lines'] = change[vul['id']]
        with open('pq_data/'+vul['id']+'.json', 'w') as f:
            f.write(json.dumps(vul, separators=(',', ':'), sort_keys=True, indent=4))

if __name__ == '__main__':
    json_files = glob.glob('./pq_data/*.json')
    vul_list = list()
    for fi in json_files:
        with open(fi) as f: vul_list.append(json.loads(f.read()))

    PQ1(vul_list)
    PQ2(vul_list)
